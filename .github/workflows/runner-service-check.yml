name: Runner Service Check

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        required: true
        type: choice
        options:
        - check-status
        - start-service
        - restart-service

jobs:
  runner-service:
    runs-on: [self-hosted, awsrunnerlocal]
    
    steps:
    - name: Check Runner Service Status
      run: |
        echo "ğŸ” Checking GitHub Actions Runner service status..."
        
        # Find the runner directory
        RUNNER_DIR=$(find /home -name "actions-runner" -type d 2>/dev/null | head -1)
        if [ -z "$RUNNER_DIR" ]; then
          RUNNER_DIR=$(find /opt -name "actions-runner" -type d 2>/dev/null | head -1)
        fi
        
        if [ -z "$RUNNER_DIR" ]; then
          echo "âŒ Runner directory not found"
          exit 1
        fi
        
        echo "ğŸ“ Runner directory: $RUNNER_DIR"
        cd "$RUNNER_DIR"
        
        # Check if service script exists
        if [ ! -f "./svc.sh" ]; then
          echo "âŒ Service script not found"
          exit 1
        fi
        
        # Check current status
        echo "ğŸ“Š Current service status:"
        ./svc.sh status || echo "Service status check completed"

    - name: Start Service
      if: github.event.inputs.action == 'start-service' || github.event.inputs.action == 'restart-service'
      run: |
        echo "ğŸš€ Starting GitHub Actions Runner service..."
        
        RUNNER_DIR=$(find /home -name "actions-runner" -type d 2>/dev/null | head -1)
        if [ -z "$RUNNER_DIR" ]; then
          RUNNER_DIR=$(find /opt -name "actions-runner" -type d 2>/dev/null | head -1)
        fi
        
        cd "$RUNNER_DIR"
        
        if [ "${{ github.event.inputs.action }}" = "restart-service" ]; then
          echo "ğŸ”„ Stopping service first..."
          ./svc.sh stop || echo "Stop completed"
          sleep 5
        fi
        
        echo "â–¶ï¸ Starting service..."
        ./svc.sh start
        
        echo "â³ Waiting for service to start..."
        sleep 10
        
        echo "âœ… Service start command completed"
        ./svc.sh status || echo "Status check completed"

    - name: Verify Runner Connection
      run: |
        echo "ğŸ” Verifying runner connection..."
        echo "Runner hostname: $(hostname)"
        echo "Current user: $(whoami)"
        echo "System uptime: $(uptime)"
        
        # Check if runner process is running
        if pgrep -f "Runner.Listener" > /dev/null; then
          echo "âœ… Runner process is active"
        else
          echo "âš ï¸ Runner process not found"
        fi
        
        # Check system resources
        echo "ğŸ’¾ System resources:"
        echo "Memory: $(free -h | grep Mem | awk '{print $3"/"$2}')"
        echo "Disk: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5" used)"}')"
        
        echo "ğŸ‰ Runner service check completed!"