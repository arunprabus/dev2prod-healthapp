name: Cost Monitor

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1

jobs:
  cost-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq bc

    - name: Run Cost Check
      run: |
        chmod +x cost-check-fixed.sh
        ./cost-check-fixed.sh

    - name: Upload Cost Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cost-report
        path: cost-report.json
        retention-days: 30

    - name: Cost Summary
      if: always()
      run: |
        echo "## 💰 Weekly Cost Report" >> $GITHUB_STEP_SUMMARY
        echo "* Period: $(date -d '7 days ago' +%Y-%m-%d) to $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
        echo "* Region: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "* Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f cost-report.json ]; then
          TOTAL_COST=$(jq -r '.ResultsByTime[].Total.BlendedCost.Amount // "0"' cost-report.json | awk '{sum += $1} END {print sum+0}')
          echo "### 📊 Cost Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Total Cost: \$${TOTAL_COST}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if (( $(echo "$TOTAL_COST > 0" | bc -l 2>/dev/null || echo "0") )); then
            echo "⚠️ **Unexpected costs detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Service Breakdown:" >> $GITHUB_STEP_SUMMARY
            jq -r '.ResultsByTime[].Groups[]? | "- \(.Keys[0]): $\(.Metrics.BlendedCost.Amount)"' cost-report.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- No breakdown available" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **All costs within Free Tier limits**" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "❌ **Cost report not generated**" >> $GITHUB_STEP_SUMMARY
        fi