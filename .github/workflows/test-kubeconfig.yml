name: Test Kubeconfig Access

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to test'
        required: true
        default: 'lower'
        type: choice
        options:
          - lower
          - higher
          - monitoring

jobs:
  test-kubeconfig:
    runs-on: [self-hosted, github-runner-lower]
    
    steps:
      - name: Test Kubeconfig Access
        env:
          KUBECONFIG_SECRET: ${{ github.event.inputs.network == 'lower' && secrets.KUBECONFIG_DEV || github.event.inputs.network == 'higher' && secrets.KUBECONFIG_PROD || secrets.KUBECONFIG_MONITORING }}
        run: |
          echo "ğŸ”§ Testing kubeconfig access for ${{ github.event.inputs.network }} network"
          
          # Decode and setup kubeconfig
          echo "$KUBECONFIG_SECRET" | base64 -d > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          
          # Test cluster access with TLS skip
          echo "ğŸ“‹ Testing cluster connection..."
          kubectl cluster-info --insecure-skip-tls-verify
          
          echo "ğŸ” Getting nodes with details..."
          kubectl get nodes -o wide --insecure-skip-tls-verify
          
          echo "âš¡ Node status and conditions..."
          kubectl describe nodes --insecure-skip-tls-verify
          
          echo "ğŸ“¦ Getting namespaces..."
          kubectl get namespaces --insecure-skip-tls-verify
          
          echo "ğŸš€ Getting pods in all namespaces..."
          kubectl get pods --all-namespaces -o wide --insecure-skip-tls-verify
          
          echo "ğŸ”§ Getting services..."
          kubectl get services --all-namespaces --insecure-skip-tls-verify
          
          echo "ğŸ“Š Getting deployments..."
          kubectl get deployments --all-namespaces --insecure-skip-tls-verify
          
          echo "ğŸ’¾ Getting persistent volumes..."
          kubectl get pv --insecure-skip-tls-verify
          
          echo "ğŸ” Getting secrets (names only)..."
          kubectl get secrets --all-namespaces --insecure-skip-tls-verify
          
          echo "âš™ï¸ Getting configmaps..."
          kubectl get configmaps --all-namespaces --insecure-skip-tls-verify
          
          echo "ğŸŒ Getting ingress..."
          kubectl get ingress --all-namespaces --insecure-skip-tls-verify
          
          echo "ğŸ“ˆ Cluster resource usage..."
          kubectl top nodes --insecure-skip-tls-verify || echo "Metrics server not available"
          kubectl top pods --all-namespaces --insecure-skip-tls-verify || echo "Metrics server not available"
          
          echo "ğŸ” Cluster version info..."
          kubectl version --insecure-skip-tls-verify
          
          echo "ğŸ¥ Component status..."
          kubectl get componentstatuses --insecure-skip-tls-verify || echo "Component status not available"
          
          # Cleanup
          rm -f /tmp/kubeconfig
          
          echo "âœ… Kubeconfig test completed successfully!"