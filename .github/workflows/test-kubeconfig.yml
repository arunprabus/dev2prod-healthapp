name: Test Kubeconfig Access

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to test'
        required: true
        default: 'lower'
        type: choice
        options:
          - lower
          - higher
          - monitoring

jobs:
  test-kubeconfig:
    runs-on: [self-hosted, github-runner-lower]
    
    steps:
      - name: Test Kubeconfig Access
        env:
          KUBECONFIG_SECRET: ${{ github.event.inputs.network == 'lower' && secrets.KUBECONFIG_DEV || github.event.inputs.network == 'higher' && secrets.KUBECONFIG_PROD || secrets.KUBECONFIG_MONITORING }}
        run: |
          echo "🔧 Testing kubeconfig access for ${{ github.event.inputs.network }} network"
          
          # Decode and setup kubeconfig
          echo "$KUBECONFIG_SECRET" | base64 -d > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          
          # Test cluster access with TLS skip
          echo "📋 Testing cluster connection..."
          kubectl cluster-info --insecure-skip-tls-verify
          
          echo "🔍 Getting nodes..."
          kubectl get nodes --insecure-skip-tls-verify
          
          echo "📦 Getting namespaces..."
          kubectl get namespaces --insecure-skip-tls-verify
          
          echo "🚀 Getting pods in all namespaces..."
          kubectl get pods --all-namespaces --insecure-skip-tls-verify
          
          # Cleanup
          rm -f /tmp/kubeconfig
          
          echo "✅ Kubeconfig test completed successfully!"