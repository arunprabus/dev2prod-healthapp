name: Test GitHub Runner

on:
  workflow_dispatch:
    inputs:
      network_tier:
        description: 'Network tier to test'
        required: true
        default: 'lower'
        type: choice
        options:
          - lower
          - higher
          - monitoring

jobs:
  test-runner:
    runs-on: ${{ fromJSON(format('["self-hosted", "github-runner-{0}"]', inputs.network_tier)) }}
    
    steps:
      - name: Test Runner Connectivity
        run: |
          echo "=== Runner Test Started ==="
          echo "Runner: $(hostname)"
          echo "Network Tier: ${{ inputs.network_tier }}"
          echo "Date: $(date)"
          echo "User: $(whoami)"
          
      - name: Collect System Information
        run: |
          echo "=== System Information ==="
          uname -a
          df -h
          free -h
          
          # Collect for summary
          echo "HOSTNAME=$(hostname)" >> $GITHUB_ENV
          echo "OS_INFO=$(uname -a)" >> $GITHUB_ENV
          echo "DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}')" >> $GITHUB_ENV
          echo "MEMORY_USAGE=$(free -h | grep Mem | awk '{print $3"/"$2}')" >> $GITHUB_ENV
          
      - name: Test Network Connectivity
        run: |
          echo "=== Network Tests ==="
          GITHUB_API=$(curl -s https://api.github.com/zen && echo "✅ Connected" || echo "❌ Failed")
          INTERNET=$(ping -c 3 8.8.8.8 > /dev/null 2>&1 && echo "✅ Connected" || echo "❌ Failed")
          
          echo "GITHUB_API_STATUS=$GITHUB_API" >> $GITHUB_ENV
          echo "INTERNET_STATUS=$INTERNET" >> $GITHUB_ENV
          
      - name: Check Installed Software
        run: |
          echo "=== Software Check ==="
          
          # Check Docker
          DOCKER_VER=$(docker --version 2>/dev/null || echo "Not installed")
          echo "DOCKER_VERSION=$DOCKER_VER" >> $GITHUB_ENV
          
          # Check kubectl
          KUBECTL_VER=$(kubectl version --client --short 2>/dev/null || echo "Not installed")
          echo "KUBECTL_VERSION=$KUBECTL_VER" >> $GITHUB_ENV
          
          # Check other tools
          GIT_VER=$(git --version 2>/dev/null || echo "Not installed")
          CURL_VER=$(curl --version | head -1 2>/dev/null || echo "Not installed")
          JQ_VER=$(jq --version 2>/dev/null || echo "Not installed")
          
          echo "GIT_VERSION=$GIT_VER" >> $GITHUB_ENV
          echo "CURL_VERSION=$CURL_VER" >> $GITHUB_ENV
          echo "JQ_VERSION=$JQ_VER" >> $GITHUB_ENV
          
      - name: Generate Summary
        run: |
          echo "## 🤖 GitHub Runner Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Basic Information" >> $GITHUB_STEP_SUMMARY
          echo "**Network Tier:** ${{ inputs.network_tier }}" >> $GITHUB_STEP_SUMMARY
          echo "**Runner:** $HOSTNAME" >> $GITHUB_STEP_SUMMARY
          echo "**OS:** $OS_INFO" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 💾 System Resources" >> $GITHUB_STEP_SUMMARY
          echo "**Disk Usage:** $DISK_USAGE" >> $GITHUB_STEP_SUMMARY
          echo "**Memory Usage:** $MEMORY_USAGE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 🌐 Network Connectivity" >> $GITHUB_STEP_SUMMARY
          echo "**GitHub API:** $GITHUB_API_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**Internet:** $INTERNET_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 🛠️ Installed Software" >> $GITHUB_STEP_SUMMARY
          echo "**Docker:** $DOCKER_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**kubectl:** $KUBECTL_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Git:** $GIT_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**curl:** $CURL_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**jq:** $JQ_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ✅ Test Status" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** ✅ All tests completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Runner Status:** Ready for GitHub Actions jobs" >> $GITHUB_STEP_SUMMARY
          
          echo "✅ Runner test completed successfully!"
          echo "Runner is working properly on network tier: ${{ inputs.network_tier }}"