name: Core Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        required: true
        type: choice
        options:
        - deploy
        - destroy
        - plan
      environment:
        description: 'Network/Environment'
        required: true
        default: 'lower'
        type: choice
        options:
        - lower
        - higher
        - monitoring
        - all
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: false
        type: string
      restore_from_snapshot:
        description: 'Restore RDS from snapshot'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-south-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  infrastructure:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    strategy:
      matrix:
        env: ${{ github.event.inputs.environment == 'all' && fromJson('["lower", "higher", "monitoring"]') || fromJson(format('["{0}"]', github.event.inputs.environment)) }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}



    - name: Terraform Init
      working-directory: infra
      run: |
        terraform init \
          -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
          -backend-config="key=health-app-${{ matrix.env }}.tfstate" \
          -backend-config="region=$AWS_REGION"

    - name: Terraform Plan
      working-directory: infra
      if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'deploy'
      run: |
        terraform plan \
          -var-file="environments/${{ matrix.env }}.tfvars" \
          -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
          -var="restore_from_snapshot=${{ github.event.inputs.restore_from_snapshot }}" \
          -out=tfplan

    - name: Terraform Apply
      id: terraform-apply
      working-directory: infra
      if: github.event.inputs.action == 'deploy'
      run: terraform apply -auto-approve tfplan

    - name: Terraform Destroy
      working-directory: infra
      if: github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'DESTROY'
      run: |
        terraform destroy \
          -var-file="environments/${{ matrix.env }}.tfvars" \
          -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
          -var="restore_from_snapshot=${{ github.event.inputs.restore_from_snapshot }}" \
          -auto-approve



    - name: Upload kubeconfig to S3
      if: github.event.inputs.action == 'deploy'
      working-directory: infra
      run: |
        # Get cluster IP from Terraform output
        CLUSTER_IP=$(terraform output -raw k3s_instance_ip 2>/dev/null || echo "")
        
        if [[ -n "$CLUSTER_IP" && "$CLUSTER_IP" != *"error"* && "$CLUSTER_IP" != "null" ]]; then
          echo "âœ… Infrastructure deployed successfully!"
          echo "ðŸŒ Cluster IP: $CLUSTER_IP"
          echo "ðŸ”— API Endpoint: https://$CLUSTER_IP:6443"
          
          # Wait for instance to be ready
          echo "â±ï¸ Waiting for instance to be ready..."
          sleep 60
          
          # Create SSH key for connection
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/aws-key
          chmod 600 ~/.ssh/aws-key
          
          # Get kubeconfig from cluster and upload to S3
          echo "ðŸ”§ Getting kubeconfig from cluster..."
          if ssh -i ~/.ssh/aws-key -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@$CLUSTER_IP 'sudo cat /etc/rancher/k3s/k3s.yaml' > /tmp/k3s-config; then
            # Replace 127.0.0.1 with actual cluster IP
            sed "s|127.0.0.1:6443|$CLUSTER_IP:6443|g" /tmp/k3s-config > /tmp/kubeconfig-${{ matrix.env }}.yaml
            
            # Upload to S3
            S3_PATH="kubeconfig/${{ matrix.env }}-network.yaml"
            aws s3 cp /tmp/kubeconfig-${{ matrix.env }}.yaml s3://${{ secrets.TF_STATE_BUCKET }}/$S3_PATH
            
            echo "âœ… Kubeconfig uploaded to S3: s3://${{ secrets.TF_STATE_BUCKET }}/$S3_PATH"
          else
            echo "âŒ Failed to get kubeconfig from cluster"
            echo "ðŸ“‹ Manual setup may be required"
          fi
        else
          echo "âŒ Cluster IP not available: $CLUSTER_IP"
        fi

    - name: Cleanup on Failure
      if: failure() && github.event.inputs.action == 'deploy' && steps.terraform-apply.outcome == 'failure'
      working-directory: infra
      run: |
        echo "ðŸ§¹ Terraform deployment failed - cleaning up partial resources"
        
        terraform destroy \
          -var-file="environments/${{ matrix.env }}.tfvars" \
          -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
          -auto-approve || echo "Cleanup completed (some errors expected)"
        
        echo "âœ… Cleanup completed - safe to retry deployment"

    - name: Summary
      if: always()
      working-directory: infra
      run: |
        echo "## ðŸ—ï¸ Infrastructure ${{ github.event.inputs.action }} - ${{ matrix.env }}" >> $GITHUB_STEP_SUMMARY
        echo "* Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "* Environment: ${{ matrix.env }}" >> $GITHUB_STEP_SUMMARY
        echo "* Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "* Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ job.status }}" == "success" && "${{ github.event.inputs.action }}" == "deploy" ]]; then
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get all Terraform outputs
          echo "### ðŸ“Š Infrastructure Details" >> $GITHUB_STEP_SUMMARY
          CLUSTER_IP=$(terraform output -raw k3s_instance_ip 2>/dev/null || echo "Not available")
          DB_ENDPOINT=$(terraform output -raw db_instance_endpoint 2>/dev/null || echo "Not available")
          VPC_ID=$(terraform output -raw vpc_id 2>/dev/null || echo "Not available")
          
          echo "* **K3s Cluster IP**: $CLUSTER_IP" >> $GITHUB_STEP_SUMMARY
          echo "* **K3s API Endpoint**: https://$CLUSTER_IP:6443" >> $GITHUB_STEP_SUMMARY
          echo "* **SSH Access**: ssh -i ~/.ssh/aws-key ubuntu@$CLUSTER_IP" >> $GITHUB_STEP_SUMMARY
          echo "* **Database Endpoint**: $DB_ENDPOINT" >> $GITHUB_STEP_SUMMARY
          echo "* **VPC ID**: $VPC_ID" >> $GITHUB_STEP_SUMMARY
          echo "* **AWS Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Kubeconfig status
          S3_PATH="kubeconfig/${{ matrix.env }}-network.yaml"
          if aws s3 ls s3://${{ secrets.TF_STATE_BUCKET }}/$S3_PATH >/dev/null 2>&1; then
            echo "### ðŸ” Kubeconfig Status" >> $GITHUB_STEP_SUMMARY
            echo "* **S3 Location**: s3://${{ secrets.TF_STATE_BUCKET }}/$S3_PATH" >> $GITHUB_STEP_SUMMARY
            echo "* **Status**: âœ… Uploaded to S3 successfully" >> $GITHUB_STEP_SUMMARY
            echo "* **Re-run Safe**: Yes, kubeconfig will be updated automatically" >> $GITHUB_STEP_SUMMARY
            echo "* **Context**: health-app-${{ matrix.env }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Kubeconfig Status" >> $GITHUB_STEP_SUMMARY
            echo "* **Status**: Failed to upload kubeconfig to S3" >> $GITHUB_STEP_SUMMARY
            echo "* **Manual Setup**: ssh -i ~/.ssh/aws-key ubuntu@$CLUSTER_IP" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Infrastructure ready for application deployment" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸš€ Run Core Deployment workflow (kubeconfig auto-downloaded from S3)" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ“‹ Deploy K8s manifests: kubectl apply -f k8s/" >> $GITHUB_STEP_SUMMARY
          echo "4. ðŸ” Verify: kubectl get pods -n health-app-${{ matrix.env }}" >> $GITHUB_STEP_SUMMARY
          
        elif [[ "${{ job.status }}" == "failure" && "${{ github.event.inputs.action }}" == "deploy" ]]; then
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "* Partial resources cleaned up automatically" >> $GITHUB_STEP_SUMMARY
          echo "* Safe to retry deployment" >> $GITHUB_STEP_SUMMARY
          echo "* Check logs for error details" >> $GITHUB_STEP_SUMMARY
        fi