name: Core Infrastructure

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        required: true
        type: choice
        options:
        - deploy
        - destroy
        - plan
        - redeploy
      environment:
        description: 'Network/Environment'
        required: true
        default: 'lower'
        type: choice
        options:
        - lower
        - higher
        - monitoring
        - all
        - cleanup-all
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: false
        type: string
      restore_from_snapshot:
        description: 'Restore RDS from snapshot'
        required: false
        default: false
        type: boolean
      runner_type:
        description: 'Runner Type'
        required: false
        default: 'aws'
        type: choice
        options:
        - aws
        - github
      optimize_data_transfer:
        description: 'Run data transfer optimization'
        required: false
        default: false
        type: boolean
      cleanup_all_regions:
        description: 'Cleanup all AWS regions (for destroy only)'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-south-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  infrastructure:
    runs-on: ${{ github.event.inputs.runner_type == 'aws' && '[self-hosted, awsrunnerlocal]' || 'ubuntu-latest' }}
    permissions:
      contents: read
      actions: write
    strategy:
      matrix:
        env: ${{ github.event.inputs.environment == 'all' && fromJson('["lower", "higher", "monitoring"]') || github.event.inputs.environment == 'cleanup-all' && fromJson('["cleanup"]') || fromJson(format('["{0}"]', github.event.inputs.environment)) }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: Terraform Init
      working-directory: infra/two-network-setup
      run: |
        echo "ðŸ” Backend Configuration:"
        echo "- Bucket: ${{ secrets.TF_STATE_BUCKET }}"
        echo "- Key: health-app-${{ matrix.env }}.tfstate"
        echo "- Region: $AWS_REGION"
        echo ""
        
        terraform init \
          -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
          -backend-config="key=health-app-${{ matrix.env }}.tfstate" \
          -backend-config="region=$AWS_REGION"
        
        echo ""
        echo "ðŸ“‹ Terraform workspace: $(terraform workspace show)"
        echo "ðŸ“‹ Backend config verified"



    - name: Terraform Plan
      working-directory: infra/two-network-setup
      if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'deploy'
      run: |
        echo "ðŸ“‹ Planning infrastructure changes..."
        terraform plan \
          -var="environment=${{ matrix.env == 'lower' && 'dev' || matrix.env == 'higher' && 'prod' || 'monitoring' }}" \
          -var="network_tier=${{ matrix.env }}" \
          -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
          -var="repo_pat=${{ secrets.REPO_PAT }}" \
          -var="repo_name=${{ secrets.REPO_NAME }}" \
          -out=tfplan
        
        echo "ðŸ“Š Plan Summary:"
        terraform show -no-color tfplan | grep -E "Plan:|No changes"

    - name: Terraform Destroy (for redeploy)
      working-directory: infra/two-network-setup
      if: github.event.inputs.action == 'redeploy'
      run: |
        echo "ðŸ§¹ Destroying existing resources first..."
        terraform destroy \
          -var="environment=${{ matrix.env == 'lower' && 'dev' || matrix.env == 'higher' && 'prod' || 'monitoring' }}" \
          -var="network_tier=${{ matrix.env }}" \
          -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
          -var="repo_pat=${{ secrets.REPO_PAT }}" \
          -var="repo_name=${{ secrets.REPO_NAME }}" \
          -auto-approve || echo "No existing resources to destroy"
        
        echo "â³ Waiting for cleanup to complete..."
        sleep 30
        
        echo "ðŸš€ Now deploying fresh infrastructure..."
        terraform plan \
          -var="environment=${{ matrix.env == 'lower' && 'dev' || matrix.env == 'higher' && 'prod' || 'monitoring' }}" \
          -var="network_tier=${{ matrix.env }}" \
          -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
          -out=tfplan
        
        terraform apply -auto-approve tfplan

    - name: Terraform Apply
      id: terraform-apply
      working-directory: infra/two-network-setup
      if: github.event.inputs.action == 'deploy' || github.event.inputs.action == 'redeploy'
      run: |
        if [ "${{ github.event.inputs.action }}" = "deploy" ]; then
          echo "ðŸš€ Applying infrastructure changes..."
          terraform apply -auto-approve tfplan
          echo "âœ… Infrastructure deployment completed"
        fi

    - name: Complete Resource Cleanup
      if: github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'DESTROY'
      run: |
        echo "ðŸ§¹ Starting complete resource cleanup for ${{ matrix.env }} environment"
        
        # Make cleanup script executable
        chmod +x scripts/complete-cleanup.sh
        
        if [ "${{ matrix.env }}" != "cleanup" ]; then
          # Run Terraform destroy first (if state exists)
          cd infra/two-network-setup
          echo "ðŸ”§ Running Terraform destroy..."
          terraform destroy \
            -var="environment=${{ matrix.env == 'lower' && 'dev' || matrix.env == 'higher' && 'prod' || 'monitoring' }}" \
            -var="network_tier=${{ matrix.env }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var="repo_pat=${{ secrets.REPO_PAT }}" \
            -var="repo_name=${{ secrets.REPO_NAME }}" \
            -auto-approve || echo "âš ï¸ Terraform destroy completed with warnings"
          cd ../..
        fi
        
        # Run complete cleanup to catch any missed resources
        echo "ðŸ—‘ï¸ Running complete AWS resource cleanup..."
        ./scripts/complete-cleanup.sh ${{ env.AWS_REGION }} true
        
        # Run VPC cleanup
        echo "ðŸ§¹ Running VPC cleanup..."
        chmod +x scripts/vpc-cleanup.sh
        if [ "${{ github.event.inputs.cleanup_all_regions }}" = "true" ]; then
          echo "ðŸŒ Cleaning ALL regions..."
          ./scripts/vpc-cleanup.sh ${{ env.AWS_REGION }} true
        else
          echo "ðŸ“ Cleaning current region only..."
          ./scripts/vpc-cleanup.sh ${{ env.AWS_REGION }}
        fi
        
        echo "âœ… Complete cleanup finished for ${{ matrix.env }} environment"

    - name: Optimize Data Transfer
      if: github.event.inputs.optimize_data_transfer == 'true'
      run: |
        echo "ðŸ“Š Optimizing data transfer to stay within free tier"
        echo "âš ï¸ WARNING: This will stop non-production resources!"
        chmod +x scripts/data-transfer-optimizer.sh
        ./scripts/data-transfer-optimizer.sh ${{ env.AWS_REGION }} monitor
        
        echo "ðŸ”§ Applying data transfer optimizations"
        ./scripts/data-transfer-optimizer.sh ${{ env.AWS_REGION }} optimize

    - name: Infrastructure Summary
      if: (github.event.inputs.action == 'deploy' || github.event.inputs.action == 'redeploy') && (steps.terraform-apply.outcome == 'success' || github.event.inputs.action == 'redeploy')
      working-directory: infra/two-network-setup
      run: |
        echo "âœ… Infrastructure deployed successfully for ${{ matrix.env }} environment"
        echo "ðŸ“Š Resources created:"
        
        # Get outputs with error handling
        K3S_IP=$(terraform output -raw k3s_public_ip 2>/dev/null || echo "Not available")
        RUNNER_PRIVATE_IP=$(terraform output -raw github_runner_ip 2>/dev/null || echo "Not available")
        RUNNER_PUBLIC_IP=$(terraform output -raw github_runner_public_ip 2>/dev/null || echo "Not available")
        RDS_ENDPOINT=$(terraform output -raw rds_endpoint 2>/dev/null || echo "Not available")
        
        echo "- K3s Cluster IP: $K3S_IP"
        echo "- GitHub Runner Private IP: $RUNNER_PRIVATE_IP"
        echo "- GitHub Runner Public IP: $RUNNER_PUBLIC_IP"
        echo "- RDS Endpoint: $RDS_ENDPOINT"
        
        echo ""
        echo "ðŸ” All available outputs:"
        terraform output 2>/dev/null || echo "No outputs available"
        
        echo ""
        echo "ðŸš€ GitHub Runner is now available with labels: awsrunnerlocal, aws-${{ matrix.env }}"
        
        if [ "$RUNNER_PUBLIC_IP" != "Not available" ]; then
          echo "ðŸ“‹ SSH to runner: ssh -i ~/.ssh/your-key ubuntu@$RUNNER_PUBLIC_IP"
          echo "ðŸ”§ Debug runner: sudo /home/ubuntu/debug-runner.sh"
        fi


    - name: Summary
      if: always()
      working-directory: infra/two-network-setup
      run: |
        echo "## ðŸ—ï¸ Infrastructure ${{ github.event.inputs.action }} - ${{ matrix.env }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ matrix.env }}" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY